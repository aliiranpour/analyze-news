from typing import TYPE_CHECKING
from utils.logger import get_logger
from utils.parsers import parse_symbols  
from langchain_core.prompts import ChatPromptTemplate
from utils.llm import get_llm
from utils.retry import call_chain_with_backoff
from utils.parsers import parse_list, extract_section
if TYPE_CHECKING:
    from models.news_types import NewsState  

logger = get_logger(__name__)
llm = get_llm()

# def find_symbols(state: 'NewsState') -> 'NewsState':

    
#     cache = state.get('cache' , {})
#     summarize = state.get('summaries', [])
#     valid_symbols = list(state.get('valid_symbol_names', []))[:200]


#     for summary in summarize:
#         prompt = ChatPromptTemplate.from_template(  
#             """
#                 ุดูุง ฺฉ ุชุญููโฺฏุฑ ุฎุจุฑู ุจุงุฒุงุฑ ุณุฑูุงู ูุณุชุฏ.

#                 ุฏุฑ ุงุฏุงูู ฺฉ ุฎุจุฑ ุงูุชุตุงุฏ ุฎูุงุตูโุดุฏู ู ูุณุช ุงุฒ ููุงุฏูุง ูุนุชุจุฑ ุจูุฑุณ ุงุฑุงู ุงุฑุงุฆู ูโุดูุฏ. ูุธูู ุดูุง ุงู ุงุณุช ฺฉู ูุดุฎุต ฺฉูุฏ ุงู ุฎุจุฑ ุฑู ฺฉุฏุงู ููุงุฏูุง ุชุฃุซุฑฺฏุฐุงุฑ ุงุณุช.
#                 ### ูุทูุงู ุชูุงู ุฌูุจูโูุง ุฒุฑ ุฑุง ุจุฑุง ุชุญูู ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:

#                 1. **ุชุฃุซุฑ ูุณุชูู:** ุขุง ุฎุจุฑ ุจูโุทูุฑ ูุณุชูู ุจู ุญูุฒู ูุนุงูุช ุดุฑฺฉุช ูุฑุจูุท ุงุณุชุ (ูุซูุงู ุฎุจุฑ ุฏุฑุจุงุฑู ููุช ูููุงุฏ ุจุฑุง ููุงุฏูุง ููุฒ)
#                 2. **ุชุฃุซุฑ ุบุฑูุณุชูู:** ุขุง ุงุฒ ุทุฑู ุฒูุฌุฑู ุชุฃููุ ูุตุฑูุ ุง ุตูุนุช ุจุงูุงุฏุณุช/ูพุงูโุฏุณุช ููฺฉู ุงุณุช ุงุซุฑ ุจฺฏุฐุงุฑุฏุ
#                 3. **ุชุฃุซุฑ ูุงู:** ุขุง ุฏุฑุขูุฏุ ูุฒููุ ุณูุฏุ ุง ุจูุฏุฌู ุดุฑฺฉุช ุจู ูุญู ุชุญุชโุชุฃุซุฑ ูุฑุงุฑ ูโฺฏุฑุฏุ
#                 4. **ุชุฃุซุฑ ุฑูุงู ู ุงูุชุธุงุฑุงุช ุจุงุฒุงุฑ:** ุขุง ุฎุจุฑ ุจุงุนุซ ุฎูุดโุจู ุง ุจุฏุจู ูุณุจุช ุจู ุขู ุตูุนุช ุง ุดุฑฺฉุช ูโุดูุฏุ
#                 5. **ุชุฃุซุฑ ุณุงุณ ุง ููุฑุฑุงุช:** ุขุง ุณุงุณุชโูุง ุฏููุชุ ูุงูุงุชุ ุงุฑุงููโุง ุง ุตุงุฏุฑุงุช/ูุงุฑุฏุงุช ุฏุฑ ุฎุจุฑ ููฺฉู ุงุณุช ุฑู ููุงุฏ ุงุซุฑ ุจฺฏุฐุงุฑุฏุ
#                 6. **ุชุฃุซุฑ ุงุฑุฒ:** ุขุง ุดุฑฺฉุช ุตุงุฏุฑุงุชโูุญูุฑ ุง ูุงุฑุฏุงุชโูุญูุฑ ุงุณุช ู ุฎุจุฑ ุดุงูู ุชุบุฑุงุช ูุฑุฎ ุงุฑุฒ ุง ุณุงุณุชโูุง ุงุฑุฒ ุงุณุชุ
#                 7. **ุชุฃุซุฑ ุณุงุฎุชุงุฑ:** ุขุง ุฎุจุฑ ุฏุฑุจุงุฑู ุฒุฑุณุงุฎุชโูุงุ ูพุฑูฺูโูุง ุนูุฑุงูุ ุจูุฏุฌู ุนูุฑุงูุ ุงูุฑฺุ ุญููโูููู ู ุบุฑู ุงุณุช ฺฉู ููฺฉู ุงุณุช ุจูโุตูุฑุช ุจููุฏูุฏุช ุงุซุฑ ุจฺฏุฐุงุฑุฏุ
#                 8. **ุชุฃุซุฑ ุจุฎุด/ุตูุนุช:** ุขุง ุฎุจุฑ ุฑู ฺฉู ฺฉ ุตูุนุช ุง ฺฏุฑูู ุฎุงุต ุงุซุฑ ูโฺฏุฐุงุฑุฏุ (ูุซูุงู ูุฑุฎ ุจูุฑู ุจุฑุง ุจุงูฺฉโูุง)
#                 9. **ูุงุจุณุชฺฏ ุจู ููุงุฏ ุง ุณุงุฒูุงู:** ุขุง ุดุฑฺฉุช ุจู ููุงุฏ ฺฉู ุฏุฑ ุฎุจุฑ ุฐฺฉุฑ ุดุฏู ูุฑุชุจุท ุงุณุชุ (ูุซูุงู ุดุฑฺฉุชโูุง ุฒุฑูุฌููุนู ุฏููุช)
#                 10. **ุงุญุชูุงู ุชุฃุซุฑ ุจููุฏูุฏุช ุง ุบุฑูุทุน:** ุญุช ุงฺฏุฑ ุงุซุฑ ฺฉูุชุงูโูุฏุช ูุฏุงุฑุฏุ ุขุง ุฏุฑ ุจููุฏูุฏุช ุง ุฏุฑ ุณูุงุฑููุง ุฎุงุต ููฺฉู ุงุณุช ุงุซุฑฺฏุฐุงุฑ ุจุงุดุฏุ

#                 ### ุฎูุงุตู ุฎุจุฑ:
#                 {summary}

#                 ### ูุณุช ููุงุฏูุง ุจูุฑุณ:
#                 {valid_symbols}

#                 ### ุฎุฑูุฌ ููุฑุฏ ุงูุชุธุงุฑ:
#                 ูุณุช ุงุฒ ููุงุฏูุง ฺฉู ุชุญุช ุชุฃุซุฑ ุงู ุฎุจุฑ ูุฑุงุฑ ูโฺฏุฑูุฏุ ุจู ููุฑุงู ุฏูู ฺฉูุชุงู ุจุฑุง ูุฑ ููุฑุฏ.
#                 ูุฑูุช ุฎุฑูุฌ:
#                 ููุงุฏูุง: [ูุงู ููุงุฏ]

#                 ุงฺฏุฑ ูฺ ููุงุฏ ูุฑุชุจุท ูุณุชุ ููุท ฺฉ ูุณุช ุจุฑฺฏุฑุฏุงู 
#             """
#         )

#         chain = prompt | llm 
#         response = call_chain_with_backoff(chain, { 'summary': summary , 'valid_symbols' : valid_symbols })
#         text = response.content.strip()
#         print('find symbols: ', parse_list(extract_section(text, "ููุงุฏูุง")) )
#         state['symbols'] = [parse_list(extract_section(text, "ููุงุฏูุง"))] or 'nothing found'

#     return state


def find_symbols(state: 'NewsState') -> 'NewsState':
    cache = state.get('cache', {})
    valid_symbols = list(state.get('valid_symbol_names', []))[:200]

    for link, entry in cache.items():
        if 'summary' not in entry:
            continue  # ุงฺฏุฑ ุฎูุงุตู ูุฌูุฏ ูุฏุงุฑุฏุ ุฑุฏ ุดู

        if 'symbols' in entry:
            continue  # ุงฺฏุฑ ูุจูุงู ููุงุฏูุง ุงุณุชุฎุฑุงุฌ ุดุฏูโุงูุฏุ ุฑุฏ ุดู

        summary = entry['summary']

        try:
            prompt = ChatPromptTemplate.from_template("""
                 ุดูุง ฺฉ ุชุญููโฺฏุฑ ุฎุจุฑู ุจุงุฒุงุฑ ุณุฑูุงู ูุณุชุฏ.

                 ุฏุฑ ุงุฏุงูู ฺฉ ุฎุจุฑ ุงูุชุตุงุฏ ุฎูุงุตูโุดุฏู ู ูุณุช ุงุฒ ููุงุฏูุง ูุนุชุจุฑ ุจูุฑุณ ุงุฑุงู ุงุฑุงุฆู ูโุดูุฏ. ูุธูู ุดูุง ุงู ุงุณุช ฺฉู ูุดุฎุต ฺฉูุฏ ุงู ุฎุจุฑ ุฑู ฺฉุฏุงู ููุงุฏูุง ุชุฃุซุฑฺฏุฐุงุฑ ุงุณุช.
                 ### ูุทูุงู ุชูุงู ุฌูุจูโูุง ุฒุฑ ุฑุง ุจุฑุง ุชุญูู ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ:

                 1. **ุชุฃุซุฑ ูุณุชูู:** ุขุง ุฎุจุฑ ุจูโุทูุฑ ูุณุชูู ุจู ุญูุฒู ูุนุงูุช ุดุฑฺฉุช ูุฑุจูุท ุงุณุชุ (ูุซูุงู ุฎุจุฑ ุฏุฑุจุงุฑู ููุช ูููุงุฏ ุจุฑุง ููุงุฏูุง ููุฒ)
                 2. **ุชุฃุซุฑ ุบุฑูุณุชูู:** ุขุง ุงุฒ ุทุฑู ุฒูุฌุฑู ุชุฃููุ ูุตุฑูุ ุง ุตูุนุช ุจุงูุงุฏุณุช/ูพุงูโุฏุณุช ููฺฉู ุงุณุช ุงุซุฑ ุจฺฏุฐุงุฑุฏุ
                 3. **ุชุฃุซุฑ ูุงู:** ุขุง ุฏุฑุขูุฏุ ูุฒููุ ุณูุฏุ ุง ุจูุฏุฌู ุดุฑฺฉุช ุจู ูุญู ุชุญุชโุชุฃุซุฑ ูุฑุงุฑ ูโฺฏุฑุฏุ
                 4. **ุชุฃุซุฑ ุฑูุงู ู ุงูุชุธุงุฑุงุช ุจุงุฒุงุฑ:** ุขุง ุฎุจุฑ ุจุงุนุซ ุฎูุดโุจู ุง ุจุฏุจู ูุณุจุช ุจู ุขู ุตูุนุช ุง ุดุฑฺฉุช ูโุดูุฏุ
                 5. **ุชุฃุซุฑ ุณุงุณ ุง ููุฑุฑุงุช:** ุขุง ุณุงุณุชโูุง ุฏููุชุ ูุงูุงุชุ ุงุฑุงููโุง ุง ุตุงุฏุฑุงุช/ูุงุฑุฏุงุช ุฏุฑ ุฎุจุฑ ููฺฉู ุงุณุช ุฑู ููุงุฏ ุงุซุฑ ุจฺฏุฐุงุฑุฏุ
                 6. **ุชุฃุซุฑ ุงุฑุฒ:** ุขุง ุดุฑฺฉุช ุตุงุฏุฑุงุชโูุญูุฑ ุง ูุงุฑุฏุงุชโูุญูุฑ ุงุณุช ู ุฎุจุฑ ุดุงูู ุชุบุฑุงุช ูุฑุฎ ุงุฑุฒ ุง ุณุงุณุชโูุง ุงุฑุฒ ุงุณุชุ
                 7. **ุชุฃุซุฑ ุณุงุฎุชุงุฑ:** ุขุง ุฎุจุฑ ุฏุฑุจุงุฑู ุฒุฑุณุงุฎุชโูุงุ ูพุฑูฺูโูุง ุนูุฑุงูุ ุจูุฏุฌู ุนูุฑุงูุ ุงูุฑฺุ ุญููโูููู ู ุบุฑู ุงุณุช ฺฉู ููฺฉู ุงุณุช ุจูโุตูุฑุช ุจููุฏูุฏุช ุงุซุฑ ุจฺฏุฐุงุฑุฏุ
                 8. **ุชุฃุซุฑ ุจุฎุด/ุตูุนุช:** ุขุง ุฎุจุฑ ุฑู ฺฉู ฺฉ ุตูุนุช ุง ฺฏุฑูู ุฎุงุต ุงุซุฑ ูโฺฏุฐุงุฑุฏุ (ูุซูุงู ูุฑุฎ ุจูุฑู ุจุฑุง ุจุงูฺฉโูุง)
                 9. **ูุงุจุณุชฺฏ ุจู ููุงุฏ ุง ุณุงุฒูุงู:** ุขุง ุดุฑฺฉุช ุจู ููุงุฏ ฺฉู ุฏุฑ ุฎุจุฑ ุฐฺฉุฑ ุดุฏู ูุฑุชุจุท ุงุณุชุ (ูุซูุงู ุดุฑฺฉุชโูุง ุฒุฑูุฌููุนู ุฏููุช)
                 10. **ุงุญุชูุงู ุชุฃุซุฑ ุจููุฏูุฏุช ุง ุบุฑูุทุน:** ุญุช ุงฺฏุฑ ุงุซุฑ ฺฉูุชุงูโูุฏุช ูุฏุงุฑุฏุ ุขุง ุฏุฑ ุจููุฏูุฏุช ุง ุฏุฑ ุณูุงุฑููุง ุฎุงุต ููฺฉู ุงุณุช ุงุซุฑฺฏุฐุงุฑ ุจุงุดุฏุ

                 ### ุฎูุงุตู ุฎุจุฑ:
                 {summary}

                 ### ูุณุช ููุงุฏูุง ุจูุฑุณ:
                 {valid_symbols}

                โณ๏ธ ูุฑูุช ุฎุฑูุฌ:
                    ูุทูุงู **ููุท** ฺฉ ุฎุท ุจุง ูุฑูุช ุฏูู ุฒุฑ ุชููุฏ ฺฉูุฏุ ุจุฏูู ูฺ ูุชู ุงุถุงู:

                    ููุงุฏูุง: ["ููุงุฏ1", "ููุงุฏ2", "ููุงุฏ3"]

                    ุงฺฏุฑ ูฺ ููุงุฏ ูุฑุชุจุท ูุณุชุ ุจููุณ:
                    ููุงุฏูุง: []
            """)

            chain = prompt | llm 
            response = call_chain_with_backoff(chain, {
                'summary': summary,
                'valid_symbols': valid_symbols
            })

            text = response.content.strip()
            extracted = parse_list(extract_section(text, "ููุงุฏูุง"))
            cleaned_symbols = [sym.strip("'\" ") for sym in extracted if sym.strip("'\" ")]

            print(f"๐ find symbols for {link} โ", extracted)

            entry['symbols'] = cleaned_symbols

        except Exception as e:
            logger.error(f"Error extracting symbols for {link}: {str(e)}")
            entry['symbols'] = []

    state['cache'] = cache
    return state
